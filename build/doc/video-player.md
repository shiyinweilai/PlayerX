# Video-Compare 项目分析文档

## 项目概述

Video-Compare 是一个用 C++14 编写的分屏视频比较工具，基于 FFmpeg 多媒体框架和 SDL2 图形库。该项目提供了强大的视频比较功能，支持两个视频文件的同步播放和视觉比较。

**主要特性：**
- 支持不同分辨率、帧率、编码格式的视频文件比较
- 多种显示模式：分屏、垂直堆叠、水平堆叠
- 实时时间偏移调整
- 硬件加速支持
- HDR/SDR 色彩空间转换
- 多种视频滤镜处理
- 交互式导航和控制

## 项目架构

### 核心架构图

```
┌─────────────────┐    ┌─────────────────┐
│    Main.cpp     │───▶│ video-compare类  │
│ (命令行解析)     │    │  (主控制器)     │
└─────────────────┘    └─────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
    ┌─────▼─────┐       ┌─────▼─────┐       ┌─────▼─────┐
    │  Demuxer  │       │  Decoder  │       │ Filterer  │
    │ (解复用器) │       │ (解码器)  │       │ (过滤器)  │
    └───────────┘       └───────────┘       └───────────┘
                              │
                        ┌─────▼─────┐
                        │ Converter │
                        │ (转换器)  │
                        └───────────┘
                              │
                        ┌─────▼─────┐
                        │  Display  │
                        │  (显示)   │
                        └───────────┘
```

### 多线程处理流程

项目采用多线程架构，每个处理阶段都在独立的线程中运行：

1. **解复用线程** (Demultiplexer) - 读取视频文件，分离音视频流
2. **解码线程** (Decoder) - 解码视频帧
3. **过滤线程** (Filterer) - 应用视频滤镜
4. **格式转换线程** (Converter) - 统一视频格式
5. **显示线程** (Display) - 渲染和用户交互

## 文件功能详细说明

### 核心文件

#### 1. main.cpp
- **功能**: 程序入口点，命令行参数解析
- **关键函数**:
  - `main()`: 主函数，处理命令行参数
  - `parse_time_shift()`: 解析时间偏移参数
  - `find_matching_*()`: 搜索FFmpeg组件
  - `print_controls()`: 显示控制说明

#### 2. video_compare.h / video_compare.cpp
- **功能**: 主控制类，协调所有处理阶段
- **关键类**: `video-compare`
- **主要方法**:
  - 多线程管理: `thread_demultiplex_*()`, `thread_decode_*()`, `thread_filter_*()`
  - 队列管理: 包队列、解码帧队列、过滤帧队列
  - 异常处理: `ExceptionHolder` 类

#### 3. config.h
- **功能**: 配置结构定义
- **关键结构**:
  - `video-compareConfig`: 全局配置
  - `InputVideo`: 单个视频输入配置
  - `TimeShiftConfig`: 时间偏移配置

#### 4. display.h / display.cpp
- **功能**: 显示和用户界面处理
- **关键类**: `Display`
- **主要功能**:
  - SDL2窗口和渲染器管理
  - 视频帧渲染和显示
  - 用户输入处理（键盘、鼠标）
  - 元数据显示和帮助信息
  - 图像保存功能

### 处理模块文件

#### 5. demuxer.h / demuxer.cpp
- **功能**: 视频文件解复用
- **职责**: 读取容器格式，分离视频流

#### 6. video_decoder.h / video_decoder.cpp
- **功能**: 视频解码
- **支持**: 软件解码和硬件加速解码

#### 7. video_filterer.h / video_filterer.cpp
- **功能**: 视频滤镜处理
- **支持**: FFmpeg滤镜链应用

#### 8. format_converter.h / format_converter.cpp
- **功能**: 视频格式转换
- **职责**: 统一左右视频的像素格式和分辨率

### 工具类文件

#### 9. controls.h / controls.cpp
- **功能**: 键盘控制映射和说明

#### 10. string_utils.h / string_utils.cpp
- **功能**: 字符串处理工具函数

#### 11. side_aware_logger.h / side_aware_logger.cpp
- **功能**: 带侧边信息的日志记录

#### 12. timer.h / timer.cpp
- **功能**: 定时器和时间管理

#### 13. queue.h
- **功能**: 线程安全队列实现

#### 14. row_workers.h
- **功能**: 并行行处理工作器

#### 15. png_saver.h / png_saver.cpp
- **功能**: PNG图像保存功能

## 主要流程分析

### 1. 初始化阶段
```cpp
// main.cpp 中的初始化流程
1. 解析命令行参数
2. 注册FFmpeg组件
3. 创建video-compare配置
4. 初始化video-compare实例
```

### 2. 视频处理流水线
```cpp
// video-compare::operator()() 中的处理流程
1. 创建各个处理模块实例
2. 启动多线程处理:
   - 解复用线程 ×2 (左右视频)
   - 解码线程 ×2
   - 过滤线程 ×2
   - 格式转换线程 ×2
3. 主循环:
   - 处理用户输入
   - 更新显示
   - 检查异常
```

### 3. 数据流处理
```
文件 → 解复用 → 包队列 → 解码 → 解码帧队列 → 过滤 → 过滤帧队列 → 格式转换 → 显示
```

### 4. 用户交互处理
```cpp
// Display::input() 中的交互处理
1. 处理SDL事件（键盘、鼠标）
2. 更新播放状态（播放/暂停/循环）
3. 处理时间偏移和帧导航
4. 更新显示模式和相关设置
```

## 关键技术特性

### 多线程架构
- 每个视频处理阶段都在独立线程中运行
- 使用线程安全队列进行数据传递
- 支持并行处理提高性能

### 灵活的配置系统
- 支持命令行参数配置
- 可分别配置左右视频的处理参数
- 支持占位符替换简化配置

### 强大的显示功能
- 支持多种显示模式
- 实时缩放和平移
- 像素级比较和差异显示
- 丰富的元数据显示

### 扩展性设计
- 模块化设计便于功能扩展
- 支持FFmpeg滤镜链
- 可配置的硬件加速

## 构建和依赖

### 主要依赖
- **FFmpeg**: 视频解码和处理
- **SDL2**: 图形显示和用户交互
- **SDL2_ttf**: 字体渲染

### 构建命令
```bash
make        # 编译
make install # 安装（需要root权限）
```

## 使用示例

```bash
# 基本使用
video-compare video1.mp4 video2.mp4

# 带时间偏移
video-compare -t 0.080 video1.mp4 video2.mp4

# 垂直堆叠显示
video-compare -m vstack video1.mp4 video2.mp4

# 应用滤镜
video-compare -l crop=iw:ih-240 video1.mp4 video2.mp4
```

## 总结

Video-Compare 项目展现了一个成熟的多媒体处理应用程序的完整架构。其模块化设计、多线程处理和丰富的功能使其成为一个优秀的视频比较工具参考实现。代码结构清晰，功能完整，是学习C++多媒体编程的绝佳示例。